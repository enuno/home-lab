# Unbound DNS Configuration for Tor Exit Node
# Generated by Ansible on {{ ansible_date_time.iso8601 }}

server:
    # Basic Configuration
    verbosity: 1
    interface: 127.0.0.1
    port: 53
    do-ip4: yes
    do-ip6: {% if tor_ipv6_enabled %}yes{% else %}no{% endif %}
    do-udp: yes
    do-tcp: yes

    # Performance Tuning
    num-threads: {{ ansible_processor_vcpus }}
    msg-cache-slabs: {{ ansible_processor_vcpus }}
    rrset-cache-slabs: {{ ansible_processor_vcpus }}
    infra-cache-slabs: {{ ansible_processor_vcpus }}
    key-cache-slabs: {{ ansible_processor_vcpus }}

    # Cache Configuration
    cache-max-ttl: 86400
    cache-min-ttl: 300
    rrset-cache-size: {{ unbound_cache_size }}
    msg-cache-size: {{ (unbound_cache_size | regex_replace('m$', '') | int / 2) | int }}m

    # Security Settings
    hide-identity: yes
    hide-version: yes
    harden-glue: yes
    harden-dnssec-stripped: yes
    harden-below-nxdomain: yes
    harden-referral-path: yes
    use-caps-for-id: yes

    # DNSSEC Validation
    {% if unbound_enable_dnssec %}
    auto-trust-anchor-file: "/var/lib/unbound/root.key"
    val-log-level: 1
    {% endif %}

    # Privacy Settings
    {% if unbound_qname_minimization %}
    qname-minimisation: yes
    qname-minimisation-strict: no
    {% endif %}

    # Root Hints
    root-hints: "/var/lib/unbound/root.hints"

    # Access Control
    access-control: 127.0.0.0/8 allow
    access-control: ::1 allow
    access-control: 0.0.0.0/0 refuse
    access-control: ::0/0 refuse

    # Logging
    logfile: "/var/log/unbound/unbound.log"
    log-queries: no
    log-replies: no
    log-servfail: yes

    # Performance
    so-rcvbuf: 4m
    so-sndbuf: 4m
    so-reuseport: yes

    # Prefetching
    prefetch: yes
    prefetch-key: yes

    # TCP Configuration for Tor
    outgoing-range: 8192
    num-queries-per-thread: 4096
    outgoing-num-tcp: 256
    incoming-num-tcp: 256

# Remote Control (for unbound-control)
remote-control:
    control-enable: yes
    control-interface: 127.0.0.1
