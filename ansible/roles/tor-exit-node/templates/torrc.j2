# Tor Exit Node Configuration
# Generated by Ansible on {{ ansible_date_time.iso8601 }}
# DO NOT EDIT MANUALLY - Changes will be overwritten

# ========================================
# Basic Relay Configuration
# ========================================

# Relay nickname (alphanumeric, no spaces)
Nickname {{ tor_relay_nickname }}

# Contact information (REQUIRED for exit relays)
ContactInfo {{ tor_contact_info }}

# ORPort - Port for incoming Tor connections
ORPort {{ tor_or_port }}

{% if tor_ipv6_enabled and ansible_default_ipv6 is defined %}
# IPv6 ORPort
ORPort {{ tor_ipv6_orport }}
{% endif %}

{% if tor_dir_port is defined and tor_dir_port | int > 0 %}
# DirPort - Directory port for serving directory information
DirPort {{ tor_dir_port }}
{% if tor_exit_notice_enabled %}
DirPortFrontPage {{ tor_exit_notice_file }}
{% endif %}
{% endif %}

# ========================================
# Exit Relay Configuration
# ========================================

# Enable exit relay functionality
ExitRelay {{ '1' if tor_exit_relay else '0' }}

{% if tor_reduced_exit_policy %}
# Reduced Exit Policy (recommended to minimize abuse)
# This allows common services while blocking high-risk ports
ExitPolicy accept *:20-21     # FTP
ExitPolicy accept *:22         # SSH
ExitPolicy accept *:23         # Telnet
ExitPolicy accept *:43         # WHOIS
ExitPolicy accept *:53         # DNS
ExitPolicy accept *:79-81      # Finger, HTTP
ExitPolicy accept *:88         # Kerberos
ExitPolicy accept *:110        # POP3
ExitPolicy accept *:143        # IMAP
ExitPolicy accept *:194        # IRC
ExitPolicy accept *:220        # IMAP3
ExitPolicy accept *:389        # LDAP
ExitPolicy accept *:443        # HTTPS
ExitPolicy accept *:464        # Kerberos
ExitPolicy accept *:465        # SMTPS
ExitPolicy accept *:531        # IRC/AIM
ExitPolicy accept *:543-544    # Kerberos
ExitPolicy accept *:554        # RTSP
ExitPolicy accept *:563        # NNTP over SSL
ExitPolicy accept *:587        # SMTP
ExitPolicy accept *:636        # LDAPS
ExitPolicy accept *:706        # SILC
ExitPolicy accept *:749        # Kerberos
ExitPolicy accept *:873        # rsync
ExitPolicy accept *:902-904    # VMware
ExitPolicy accept *:981        # HTTPS alt
ExitPolicy accept *:989-995    # FTPS, Telnet, IMAP, IRC, POP3 over SSL
ExitPolicy accept *:1194       # OpenVPN
ExitPolicy accept *:1220       # QT Server Admin
ExitPolicy accept *:1293       # IPsec
ExitPolicy accept *:1500       # VLSI License Manager
ExitPolicy accept *:1533       # Sametime
ExitPolicy accept *:1677       # GroupWise
ExitPolicy accept *:1723       # PPTP
ExitPolicy accept *:1755       # MMS/WMS
ExitPolicy accept *:1863       # MSN
ExitPolicy accept *:2082       # Infowave
ExitPolicy accept *:2083       # Secure Radius
ExitPolicy accept *:2086-2087  # GNUnet, ELI
ExitPolicy accept *:2095-2096  # NBX
ExitPolicy accept *:2102-2104  # Zephyr
ExitPolicy accept *:3128       # SQUID
ExitPolicy accept *:3389       # RDP
ExitPolicy accept *:3690       # SVN
ExitPolicy accept *:4321       # RWHOIS
ExitPolicy accept *:4643       # Virtuozzo
ExitPolicy accept *:5050       # Yahoo! Messenger
ExitPolicy accept *:5190       # AIM/ICQ
ExitPolicy accept *:5222-5223  # XMPP, XMPP over SSL
ExitPolicy accept *:5228       # Android Market
ExitPolicy accept *:5900       # VNC
ExitPolicy accept *:6660-6669  # IRC
ExitPolicy accept *:6679       # IRC SSL
ExitPolicy accept *:6697       # IRC SSL
ExitPolicy accept *:8000       # iRDMI
ExitPolicy accept *:8008       # HTTP alternate
ExitPolicy accept *:8074       # Gadu-Gadu
ExitPolicy accept *:8080       # HTTP Proxies
ExitPolicy accept *:8082       # HTTPS Electrum Bitcoin port
ExitPolicy accept *:8087-8088  # Simplify Media SPP Protocol, Radan HTTP
ExitPolicy accept *:8332-8333  # Bitcoin
ExitPolicy accept *:8443       # PCsync HTTPS
ExitPolicy accept *:8888       # HTTP Proxies, NewsEDGE
ExitPolicy accept *:9418       # git
ExitPolicy accept *:9999       # distinct
ExitPolicy accept *:10000      # Network Data Management Protocol
ExitPolicy accept *:11371      # OpenPGP HTTP Keyserver
ExitPolicy accept *:19294      # Google Voice TCP
ExitPolicy accept *:19638      # Ensim control panel
ExitPolicy accept *:50002      # Electrum Bitcoin SSL
ExitPolicy accept *:64738      # Mumble
ExitPolicy reject *:*          # Reject all other ports
{% else %}
# Custom Exit Policy
{% for policy in tor_custom_exit_policy %}
ExitPolicy {{ policy }}
{% endfor %}
{% endif %}

# ========================================
# Bandwidth Configuration
# ========================================

# Bandwidth limits (in KB/s)
# Set slightly below actual capacity for reliability
BandwidthRate {{ tor_bandwidth_rate }} KB
BandwidthBurst {{ tor_bandwidth_burst }} KB

# Relay bandwidth (if different from general bandwidth)
RelayBandwidthRate {{ tor_relay_bandwidth_rate }} KB
RelayBandwidthBurst {{ tor_relay_bandwidth_burst }} KB

{% if tor_accounting_enabled %}
# Bandwidth accounting (optional)
AccountingStart {{ tor_accounting_start }}
AccountingMax {{ tor_accounting_max }}
{% endif %}

# ========================================
# Directory and File Locations
# ========================================

# Data directory
DataDirectory {{ tor_data_dir }}

# PID file
PidFile /run/tor/tor.pid

# ========================================
# Logging Configuration
# ========================================

{% if tor_log_destination == 'syslog' %}
# Log to syslog
Log {{ tor_log_level }} syslog
{% else %}
# Log to file
Log {{ tor_log_level }} file /var/log/tor/tor.log
{% endif %}

# ========================================
# Control Port Configuration
# ========================================

# Control port (localhost only, for monitoring)
ControlPort {{ tor_control_port }}
CookieAuthentication 1
CookieAuthFileGroupReadable 1

# ========================================
# Performance and Connection Limits
# ========================================

# Maximum number of file descriptors
# Should match system ulimit configuration
ConnLimit {{ tor_max_connections }}

# Maximum circuits
MaxCircuitDirtiness 600

# DNS Configuration
{% if tor_install_unbound %}
# Use local resolver
ServerDNSResolvConfFile /etc/resolv.conf
{% endif %}

# Disable DNS timeout warnings for high-bandwidth relays
ServerDNSDetectHijacking 0

# ========================================
# Security Settings
# ========================================

# Disable local services that aren't needed
DisableDebuggerAttachment 1

# Use only strong SSL ciphers
SSLCipherList ECDHE-RSA-AES256-GCM-SHA384:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-RSA-AES256-SHA384:ECDHE-RSA-AES128-SHA256

# ========================================
# Additional Options
# ========================================

# Reject unknown client versions (disabled for exit nodes)
# This is more important for entry guards
# ClientRejectInternalAddresses 1

# Address to advertise (leave commented to auto-detect)
# Address {{ ansible_default_ipv4.address }}

{% if tor_ipv6_enabled and ansible_default_ipv6 is defined %}
# IPv6 address
# Address {{ ansible_default_ipv6.address }}
{% endif %}

# ========================================
# Directory Authority Servers
# ========================================
# (Use defaults - no need to specify)

# ========================================
# End of Configuration
# ========================================

# For more information, see:
# https://www.torproject.org/docs/tor-manual.html.en
