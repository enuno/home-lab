# Ubiquiti UniFi UDM Pro BGP Configuration for K3s MetalLB Anycast
# Generated by Ansible for homelab cluster
#
# Router ASN: {{ metallb_bgp_asn }}
# Cluster ASN Range: {{ metallb_node_asn_base }} - {{ metallb_node_asn_base + metallb_nodes | length - 1 }}
# IP Pool: {{ metallb_bgp_ip_pools[0].addresses[0] }}
#
# IMPORTANT: UniFi UDM Pro uses a JSON-based configuration system
# This file contains the configuration that needs to be applied via:
# 1. UniFi Network Application (GUI)
# 2. UDM Pro CLI (if available)
# 3. Configuration backup/restore method

{
  "version": "1.0.0",
  "description": "BGP Configuration for K3s MetalLB Anycast",
  "bgp": {
    "enabled": true,
    "asn": {{ metallb_bgp_asn }},
    "router_id": "{{ metallb_bgp_router_ip }}",
    "graceful_restart": {
      "enabled": true,
      "restart_time": 120,
      "stalepath_time": 360
    },
    "neighbors": [
{% for node_ip in metallb_nodes %}
      {
        "ip": "{{ node_ip }}",
        "remote_as": {{ metallb_node_asn_base + loop.index0 }},
        "description": "K3s Node {{ loop.index }}",
        "hold_time": 90,
        "keepalive_time": 30,
        "graceful_restart": true,
{% if metallb_bgp_password | length > 0 %}
        "password": "{{ metallb_bgp_password }}",
{% endif %}
        "capabilities": {
          "extended_nexthop": true,
          "route_refresh": true
        }
      }{% if not loop.last %},{% endif %}
{% endfor %}
    ],
    "address_families": {
      "ipv4_unicast": {
        "enabled": true,
        "networks": [
          {
            "network": "{{ metallb_bgp_ip_pools[0].addresses[0] }}",
            "description": "MetalLB IP Pool"
          }
        ],
        "redistribute": {
          "connected": false,
          "static": false
        }
      }
    },
    "route_maps": {
      "metallb_in": {
        "sequence": 10,
        "action": "permit",
        "match": {
          "source_protocol": "bgp"
        },
        "set": {
          "local_preference": 100
        }
      },
      "metallb_out": {
        "sequence": 10,
        "action": "permit",
        "match": {
          "source_protocol": "bgp"
        },
        "set": {
          "metric": 100
        }
      }
    },
    "policies": {
      "import": ["metallb_in"],
      "export": ["metallb_out"]
    }
  },
  "logging": {
    "bgp": {
      "enabled": true,
      "level": "info",
      "file": "/var/log/bgp.log"
    }
  }
}

# Alternative: CLI Configuration Commands
# If you have CLI access to UDM Pro, you can use these commands:
#
# configure
# router bgp {{ metallb_bgp_asn }}
#   bgp router-id {{ metallb_bgp_router_ip }}
#   bgp graceful-restart
#   bgp graceful-restart restart-time 120
#   bgp graceful-restart stalepath-time 360
#
{% for node_ip in metallb_nodes %}
#   neighbor {{ node_ip }} remote-as {{ metallb_node_asn_base + loop.index0 }}
#   neighbor {{ node_ip }} description "K3s Node {{ loop.index }}"
#   neighbor {{ node_ip }} timers 30 90
#   neighbor {{ node_ip }} graceful-restart
#   neighbor {{ node_ip }} capability extended-nexthop
{% if metallb_bgp_password | length > 0 %}
#   neighbor {{ node_ip }} password {{ metallb_bgp_password }}
{% endif %}
#   neighbor {{ node_ip }} activate
#   neighbor {{ node_ip }} next-hop-self
#   neighbor {{ node_ip }} route-reflector-client
#
{% endfor %}
#   network {{ metallb_bgp_ip_pools[0].addresses[0] }}
# !
# exit
# commit
# save
