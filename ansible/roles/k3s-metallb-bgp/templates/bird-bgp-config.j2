# BIRD BGP Configuration for K3s MetalLB Anycast
# Generated by Ansible for homelab cluster
#
# Router ASN: {{ metallb_bgp_asn }}
# Cluster ASN Range: {{ metallb_node_asn_base }} - {{ metallb_node_asn_base + metallb_nodes | length - 1 }}
# IP Pool: {{ metallb_bgp_ip_pools[0].addresses[0] }}

# Global BIRD configuration
router id {{ metallb_bgp_router_ip }};
protocol device {
    scan time 10;
}

# Kernel protocol for route installation
protocol kernel {
    ipv4 {
        export all;
        import all;
    };
    graceful restart;
}

# Static protocol for local routes
protocol static {
    ipv4;
    route {{ metallb_bgp_ip_pools[0].addresses[0] }} reject;
}

# BGP protocol configuration
protocol bgp metallb_cluster {
    local as {{ metallb_bgp_asn }};
    graceful restart;
    graceful restart time 120;

{% for node_ip in metallb_nodes %}
    # Neighbor {{ loop.index }}: {{ node_ip }} (ASN: {{ metallb_node_asn_base + loop.index0 }})
    neighbor {{ node_ip }} as {{ metallb_node_asn_base + loop.index0 }};
{% endfor %}

    ipv4 {
        import all;
        export all;
        next hop self;
    };

    # BGP timers
    hold time 90;
    keepalive time 30;

{% if metallb_bgp_password | length > 0 %}
    password "{{ metallb_bgp_password }}";
{% endif %}
}

# Route filters
filter metallb_filter {
    if net = {{ metallb_bgp_ip_pools[0].addresses[0] }} then {
        bgp_local_pref = 100;
        accept;
    }
    reject;
}
