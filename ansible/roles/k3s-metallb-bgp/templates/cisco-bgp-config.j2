!
! Cisco BGP Configuration for K3s MetalLB Anycast
! Generated by Ansible for homelab cluster
!
! Router ASN: {{ metallb_bgp_asn }}
! Cluster ASN Range: {{ metallb_node_asn_base }} - {{ metallb_node_asn_base + metallb_nodes | length - 1 }}
! IP Pool: {{ metallb_bgp_ip_pools[0].addresses[0] }}
!

configure terminal

! BGP Configuration
router bgp {{ metallb_bgp_asn }}
  bgp router-id {{ metallb_bgp_router_ip }}
  bgp graceful-restart
  bgp graceful-restart restart-time 120
  bgp graceful-restart stalepath-time 360

  ! Address family configurations
  address-family ipv4
{% for node_ip in metallb_nodes %}
    ! Neighbor {{ loop.index }}: {{ node_ip }} (ASN: {{ metallb_node_asn_base + loop.index0 }})
    neighbor {{ node_ip }} remote-as {{ metallb_node_asn_base + loop.index0 }}
    neighbor {{ node_ip }} description "K3s Node {{ loop.index }}"
    neighbor {{ node_ip }} timers 30 90
    neighbor {{ node_ip }} graceful-restart
    neighbor {{ node_ip }} activate
    neighbor {{ node_ip }} next-hop-self
    neighbor {{ node_ip }} route-reflector-client
{% if metallb_bgp_password | length > 0 %}
    neighbor {{ node_ip }} password {{ metallb_bgp_password }}
{% endif %}
{% endfor %}

    ! Network advertisement
    network {{ metallb_bgp_ip_pools[0].addresses[0] }}
  exit-address-family
!

! Route maps
route-map METALLB-IN permit 10
  set local-preference 100
!

route-map METALLB-OUT permit 10
  set metric 100
!

! Access lists
ip prefix-list METALLB-POOL permit {{ metallb_bgp_ip_pools[0].addresses[0] }}
!

! Logging
logging buffered 4096
logging console debugging
!

end
write memory
!
