!
! FRR BGP Configuration for K3s MetalLB Anycast
! Generated by Ansible for homelab cluster
!
! Router ASN: {{ metallb_bgp_asn }}
! Cluster ASN Range: {{ metallb_node_asn_base }} - {{ metallb_node_asn_base + metallb_nodes | length - 1 }}
! IP Pool: {{ metallb_bgp_ip_pools[0].addresses[0] }}
!

frr version 8.5.1
frr defaults traditional
hostname router
log syslog informational
service integrated-vtysh-config
!

! BGP Configuration
router bgp {{ metallb_bgp_asn }}
  bgp router-id {{ metallb_bgp_router_ip }}
  no bgp default ipv4-unicast
  bgp graceful-restart
  bgp graceful-restart restart-time 120
  bgp graceful-restart stalepath-time 360

  ! Network advertisements
  network {{ metallb_bgp_ip_pools[0].addresses[0] }}

  ! Neighbor configurations for each cluster node
{% for node_ip in metallb_nodes %}
  ! Node {{ loop.index }}: {{ node_ip }} (ASN: {{ metallb_node_asn_base + loop.index0 }})
  neighbor {{ node_ip }} remote-as {{ metallb_node_asn_base + loop.index0 }}
  neighbor {{ node_ip }} description "K3s Node {{ loop.index }}"
  neighbor {{ node_ip }} timers 30 90
  neighbor {{ node_ip }} graceful-restart
  neighbor {{ node_ip }} capability extended-nexthop
{% if metallb_bgp_password | length > 0 %}
  neighbor {{ node_ip }} password {{ metallb_bgp_password }}
{% endif %}
{% endfor %}

  ! Address family configurations
  address-family ipv4 unicast
{% for node_ip in metallb_nodes %}
    neighbor {{ node_ip }} activate
    neighbor {{ node_ip }} route-reflector-client
    neighbor {{ node_ip }} next-hop-self
{% endfor %}
    network {{ metallb_bgp_ip_pools[0].addresses[0] }}
  exit-address-family
!

! Route maps for traffic engineering
route-map METALLB-IN permit 10
  set local-preference 100
!

route-map METALLB-OUT permit 10
  set metric 100
!

! Access lists
ip prefix-list METALLB-POOL permit {{ metallb_bgp_ip_pools[0].addresses[0] }}
!

! Logging
log file /var/log/frr/bgp.log
!

! Line vty
line vty
!
