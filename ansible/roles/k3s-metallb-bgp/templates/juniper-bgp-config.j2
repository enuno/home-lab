# Juniper BGP Configuration for K3s MetalLB Anycast
# Generated by Ansible for homelab cluster
#
# Router ASN: {{ metallb_bgp_asn }}
# Cluster ASN Range: {{ metallb_node_asn_base }} - {{ metallb_node_asn_base + metallb_nodes | length - 1 }}
# IP Pool: {{ metallb_bgp_ip_pools[0].addresses[0] }}

set routing-options router-id {{ metallb_bgp_router_ip }}
set routing-options autonomous-system {{ metallb_bgp_asn }}

# BGP Group Configuration
set routing-options graceful-restart
set routing-options graceful-restart restart-time 120

# BGP Group for MetalLB cluster
set protocols bgp group metallb-cluster type internal
set protocols bgp group metallb-cluster graceful-restart
set protocols bgp group metallb-cluster graceful-restart restart-time 120

{% for node_ip in metallb_nodes %}
# Neighbor {{ loop.index }}: {{ node_ip }} (ASN: {{ metallb_node_asn_base + loop.index0 }})
set protocols bgp group metallb-cluster neighbor {{ node_ip }} peer-as {{ metallb_node_asn_base + loop.index0 }}
set protocols bgp group metallb-cluster neighbor {{ node_ip }} description "K3s Node {{ loop.index }}"
set protocols bgp group metallb-cluster neighbor {{ node_ip }} hold-time 90
set protocols bgp group metallb-cluster neighbor {{ node_ip }} keep-all
{% if metallb_bgp_password | length > 0 %}
set protocols bgp group metallb-cluster neighbor {{ node_ip }} authentication-key "{{ metallb_bgp_password }}"
{% endif %}
{% endfor %}

# BGP Policy Configuration
set policy-options policy-statement metallb-import term accept from protocol bgp
set policy-options policy-statement metallb-import term accept then local-preference 100
set policy-options policy-statement metallb-import term accept then accept

set policy-options policy-statement metallb-export term export from protocol bgp
set policy-options policy-statement metallb-export term export then metric 100
set policy-options policy-statement metallb-export term export then accept

# Apply policies
set protocols bgp group metallb-cluster import metallb-import
set protocols bgp group metallb-cluster export metallb-export

# Network advertisement
set routing-options static route {{ metallb_bgp_ip_pools[0].addresses[0] }} reject

# Logging
set system syslog file bgp.log any info
set system syslog file bgp.log match "BGP"
