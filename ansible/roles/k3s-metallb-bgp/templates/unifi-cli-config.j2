# Ubiquiti UniFi UDM Pro CLI BGP Configuration
# Generated by Ansible for K3s MetalLB Anycast
#
# Router ASN: {{ metallb_bgp_asn }}
# Cluster ASN Range: {{ metallb_node_asn_base }} - {{ metallb_node_asn_base + metallb_nodes | length - 1 }}
# IP Pool: {{ metallb_bgp_ip_pools[0].addresses[0] }}
#
# Apply these commands via SSH to your UDM Pro:
# 1. SSH to UDM Pro: ssh admin@{{ metallb_bgp_router_ip }}
# 2. Enter configuration mode: configure
# 3. Apply the commands below
# 4. Commit and save: commit && save

configure

# Enable BGP routing
router bgp {{ metallb_bgp_asn }}
  bgp router-id {{ metallb_bgp_router_ip }}
  bgp graceful-restart
  bgp graceful-restart restart-time 120
  bgp graceful-restart stalepath-time 360

  # Address family configuration
  address-family ipv4 unicast
{% for node_ip in metallb_nodes %}
    # Neighbor {{ loop.index }}: {{ node_ip }} (ASN: {{ metallb_node_asn_base + loop.index0 }})
    neighbor {{ node_ip }} remote-as {{ metallb_node_asn_base + loop.index0 }}
    neighbor {{ node_ip }} description "K3s Node {{ loop.index }}"
    neighbor {{ node_ip }} timers 30 90
    neighbor {{ node_ip }} graceful-restart
    neighbor {{ node_ip }} capability extended-nexthop
{% if metallb_bgp_password | length > 0 %}
    neighbor {{ node_ip }} password {{ metallb_bgp_password }}
{% endif %}
    neighbor {{ node_ip }} activate
    neighbor {{ node_ip }} next-hop-self
    neighbor {{ node_ip }} route-reflector-client
    neighbor {{ node_ip }} soft-reconfiguration inbound
{% endfor %}

    # Network advertisement
    network {{ metallb_bgp_ip_pools[0].addresses[0] }}
  exit-address-family
!

# Route maps for traffic engineering
route-map METALLB-IN permit 10
  set local-preference 100
  set weight 32768
!

route-map METALLB-OUT permit 10
  set metric 100
  set community 65535:65282
!

# Access lists
ip prefix-list METALLB-POOL permit {{ metallb_bgp_ip_pools[0].addresses[0] }}
!

# Apply route maps to neighbors
{% for node_ip in metallb_nodes %}
router bgp {{ metallb_bgp_asn }}
  neighbor {{ node_ip }} route-map METALLB-IN in
  neighbor {{ node_ip }} route-map METALLB-OUT out
!
{% endfor %}

# Logging configuration
logging buffered 4096 debugging
logging console informational
logging file /var/log/bgp.log informational
!

# Commit and save configuration
commit
save

# Display BGP status
show bgp summary
show bgp neighbors
show bgp ipv4 unicast
