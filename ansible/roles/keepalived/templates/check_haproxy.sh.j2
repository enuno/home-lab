#!/bin/bash
# HAProxy Health Check Script for keepalived
# Generated by Ansible on {{ ansible_date_time.iso8601 }}
# This script checks if HAProxy container is running and responding

set -e

# Configuration
HAPROXY_CONTAINER="haproxy"
HAPROXY_STATS_PORT="{{ haproxy_stats_port }}"
HAPROXY_HEALTH_ENDPOINT="http://localhost:${HAPROXY_STATS_PORT}/health"
TIMEOUT=3

# Function to log messages
log_message() {
    logger -t keepalived-check -p daemon.info "$1"
}

# Check if HAProxy container exists and is running
if ! docker inspect -f '{{{{.State.Running}}}}' "${HAPROXY_CONTAINER}" 2>/dev/null | grep -q true; then
    log_message "CRITICAL: HAProxy container is not running"
    exit 1
fi

# Check if HAProxy is responding to health checks
if ! curl -sf --max-time "${TIMEOUT}" "${HAPROXY_HEALTH_ENDPOINT}" >/dev/null 2>&1; then
    log_message "WARNING: HAProxy health endpoint not responding"
    exit 1
fi

# All checks passed
log_message "OK: HAProxy is healthy"
exit 0
